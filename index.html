<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SkyGuard ‚Äî Live Demo</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<!-- Chart.js (kept as UMD) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg1:#080C12; --bg2:#0B0F14;
    --glass: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.08);
    --text:#E6EDF6; --muted:#9AA4B2;
    --accent1:#3B82F6; --accent2:#60A5FA;
    --green:#34C759; --orange:#FF9F0A; --red:#FF3B30;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);font:16px/1.6 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  a{color:inherit;text-decoration:none}
  .container{max-width:1200px;margin-inline:auto;padding-inline:24px}
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(12px);
    background:linear-gradient(180deg, rgba(8,12,18,.9), rgba(8,12,18,.6));
    border-bottom:1px solid var(--border);
  }
  .nav{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 0 16px var(--accent2)}
  .nav a{padding:8px 10px;border-radius:10px;color:var(--muted)}
  .nav a:hover{background:var(--glass);color:var(--text)}
  .cta{display:inline-flex;gap:10px}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;
    padding:10px 14px;border-radius:12px;border:1px solid var(--border);
    background:var(--glass); color:var(--text); cursor:pointer; transition:.2s ease;
  }
  .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,0.08)}
  .btn.primary{border:0;background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#0A1020; font-weight:700}
  .btn.primary:hover{filter:brightness(1.05)}
  /* hero */
  .hero{position:relative;min-height:90svh;display:grid;place-items:center;overflow:hidden}
  canvas#stars{position:absolute;inset:0;z-index:0}
  .hero-inner{position:relative;z-index:1;text-align:center;padding:56px 0}
  .kicker{color:var(--muted);letter-spacing:.2em;text-transform:uppercase;font-size:12px}
  .title{font-size: clamp(36px, 6vw, 64px); line-height:1.05; font-weight:900; letter-spacing:-.02em; margin:10px 0 8px}
  .subtitle{color:#C8D2E0; max-width:760px; margin:0 auto 24px; font-size:18px}
  .plane{position:absolute;left:-10%;top:65%;font-size:40px;filter:drop-shadow(0 2px 8px rgba(96,165,250,.6));animation:fly 4s cubic-bezier(.16,1,.3,1) 500ms forwards}
  @keyframes fly{
    0%{transform:translate(0,0) rotate(-15deg); opacity:.0}
    15%{opacity:1}
    100%{transform:translate(130vw,-45vh) rotate(20deg); opacity:1}
  }
  .sponsors{margin-top:28px; opacity:.9}
  .logos{display:flex;gap:18px;flex-wrap:wrap;justify-content:center}
  .logo{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:var(--glass);color:#9fb3c8}
  .logo:hover{color:#fff; background:rgba(96,165,250,.08); border-color:rgba(96,165,250,.35)}
  /* sections */
  section{padding:72px 0}
  .card{background:var(--glass); border:1px solid var(--border); border-radius:18px; padding:20px; box-shadow: 0 6px 24px rgba(0,0,0,.25)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(96,165,250,.1);color:#b9d7ff;border:1px solid rgba(96,165,250,.25); font-size:12px}
  h2{font-size: clamp(26px,3.5vw,40px); line-height:1.1; margin:0 0 8px}
  h3{margin:0 0 6px}
  .lead{color:#D5DEEA} .muted{color:var(--muted)}
  ul.check{padding-left:18px; margin:10px 0} ul.check li{margin:6px 0}
  .about-grid{display:grid; gap:20px; grid-template-columns:1fr}
  @media(min-width:1000px){ .about-grid{ grid-template-columns:1.2fr .8fr } }
  .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .stat{background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:14px; padding:12px; text-align:center}
  .stat b{font-size:20px}
  .team{display:grid; gap:16px; grid-template-columns:1fr}
  @media(min-width:900px){ .team{ grid-template-columns:repeat(4,1fr)} }
  .person{background:var(--glass); border:1px solid var(--border); border-radius:16px; padding:16px}
  .avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:800;color:#0A1020;margin-bottom:8px}
  .role{color:#AFC4D8; font-size:13px}
  .marquee{overflow:hidden;border:1px solid var(--border); border-radius:16px; background:rgba(255,255,255,.03)}
  .track{display:flex;gap:26px; padding:12px; animation:scroll 18s linear infinite}
  @keyframes scroll{from{transform:translateX(0)} to{transform:translateX(-50%)}}
  .badge{padding:8px 12px;border-radius:12px;border:1px solid var(--border); background:var(--glass)}
  details{border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:14px; padding:12px}
  details+details{margin-top:8px}
  summary{cursor:pointer; font-weight:600}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .spacer{height:32px}
  footer{padding:40px 0; text-align:center; color:#A7B2C1; border-top:1px solid var(--border); background:linear-gradient(180deg, transparent, rgba(255,255,255,.03))}

  /* ---------- LIVE DASHBOARD LAYOUT ---------- */
  #dashboard .wrap{display:grid; grid-template-columns: 220px 1fr 360px; gap:16px;}
  @media (max-width:1200px){
    #dashboard .wrap{ grid-template-columns: 1fr; }
    #right, #left { order:2 } #center { order:1 }
  }
  #left, #right{max-height:70vh; overflow:auto}
  #globeHolder{height:70vh; min-height:520px; border-radius:18px; border:1px solid var(--border); background:rgba(255,255,255,0.03); position:relative}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border); background:var(--glass); cursor:pointer; margin:6px 6px 0 0; font-size:13px}
  .chip.active{border-color:rgba(96,165,250,.6); box-shadow:0 0 0 2px rgba(96,165,250,.2) inset}
  .list{display:flex;flex-direction:column; gap:8px}
  .rowItem{display:flex;justify-content:space-between;align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.03)}
  .riskbar{height:8px;border-radius:999px;background:rgba(255,255,255,0.06); overflow:hidden}
  .riskbar > span{display:block;height:100%}
  .drawer{position:absolute; right:12px; bottom:12px; width:300px; border:1px solid var(--border); background:rgba(10,16,32,.8); backdrop-filter: blur(10px); border-radius:14px; padding:12px; display:none}
  .drawer.show{display:block}
  .compass{width:80px;height:80px;border-radius:50%;border:1px solid var(--border); display:grid; place-items:center; position:relative}
  .needle{position:absolute; width:2px; height:36px; background:linear-gradient(var(--accent1),var(--accent2)); transform-origin:bottom center; bottom:40px}
  .dotSm{width:8px;height:8px;border-radius:50%}
  .legend{display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted)}
  .legend .swatch{width:10px;height:10px;border-radius:3px}
  .toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--glass);cursor:pointer}
  .ctrls{position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5}
  /* ANALYTICS */
  #analytics .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1000px){ #analytics .grid{grid-template-columns:1fr 1fr} }
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--border)}
  th,td{padding:10px 12px; font-size:14px}
  thead th{background:rgba(255,255,255,0.06); text-align:left}
  tbody tr:nth-child(odd){background:rgba(255,255,255,0.03)}
  /* CHAT */
  #copilot .chat{max-width:900px;margin:0 auto}
  .inputRow{display:flex; gap:10px}
  .inputRow input{flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.04); color:var(--text)}
  .chipRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .badgeMini{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border); background:rgba(255,255,255,0.04)}
</style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav">
      <div class="brand">
        <span class="dot"></span>
        <span>SkyGuard</span>
      </div>
      <nav class="row">
        <a href="#home">Home</a>
        <a href="#dashboard">Dashboard</a>
        <a href="#analytics">Analytics</a>
        <a href="#about-skyguard">About</a>
        <a href="#team">Team</a>
      </nav>
      <div class="cta">
        <a class="btn" href="#about-skyguard">Why we built this</a>
        <a class="btn primary" href="#dashboard">Open Live Map</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section id="home" class="hero">
    <canvas id="stars"></canvas>
    <div class="hero-inner container">
      <div class="kicker">AI Aviation ‚Ä¢ Real-Time ‚Ä¢ Safety</div>
      <h1 class="title" id="typeTarget">SkyGuard</h1>
      <p class="subtitle">AI-powered airspace safety. Predict. Visualize. Prevent.</p>
      <div class="cta" style="justify-content:center; gap:12px;">
        <a class="btn primary" href="#dashboard">Enter Dashboard</a>
        <a class="btn" href="#analytics">View Safety Insights</a>
      </div>
      <div class="sponsors">
        <div class="muted" style="text-align:center;margin-bottom:8px">Trusted by US Airlines</div>
        <div class="logos">
          <span class="logo">Delta</span><span class="logo">United</span><span class="logo">Alaska</span>
          <span class="logo">Southwest</span><span class="logo">JetBlue</span><span class="logo">American</span>
        </div>
      </div>
    </div>
    <div class="plane" aria-hidden="true">‚úàÔ∏è</div>
  </section>

  <!-- LIVE DASHBOARD -->
  <section id="dashboard">
    <div class="container">
      <span class="pill">Live Flights</span>
      <h2>US Airspace ‚Äî Live Map & Alerts (Demo)</h2>
      <p class="muted">Drag to rotate. Scroll to zoom. Click a plane for details.</p>

      <div class="wrap">
        <!-- LEFT: Airline filter -->
        <div id="left" class="card">
          <h3>Airlines</h3>
          <div id="airlineChips"></div>
          <div class="spacer"></div>
          <div class="legend">
            <span class="swatch" style="background:var(--green)"></span> Low risk
            <span class="swatch" style="background:var(--orange)"></span> Medium
            <span class="swatch" style="background:var(--red)"></span> High
          </div>
        </div>

        <!-- CENTER: Globe -->
        <div id="center">
          <div id="globeHolder">
            <div class="ctrls">
              <div class="toggle" id="playPause">‚èØÔ∏è <span>Pause</span></div>
              <div class="toggle" id="wxToggle">‚õàÔ∏è <span>Weather</span></div>
              <div class="toggle" id="tourToggle">üé• <span>Tour</span></div>
            </div>
            <div id="drawer" class="drawer">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <b id="drawerTitle">Flight</b>
                <span class="badgeMini" id="drawerAirline">AA</span>
              </div>
              <div class="spacer" style="height:12px"></div>
              <div class="row" style="justify-content:space-between">
                <div>
                  <div class="muted" style="font-size:12px">Speed / Alt</div>
                  <div><b id="spAlt">‚Äî</b></div>
                </div>
                <div>
                  <div class="muted" style="font-size:12px">Heading</div>
                  <div class="compass">
                    <div id="needle" class="needle"></div>
                    <div style="position:absolute;top:6px;font-size:10px">N</div>
                    <div style="position:absolute;bottom:6px;font-size:10px">S</div>
                    <div style="position:absolute;left:6px;font-size:10px">W</div>
                    <div style="position:absolute;right:6px;font-size:10px">E</div>
                  </div>
                </div>
              </div>
              <div class="spacer" style="height:12px"></div>
              <div class="row" style="justify-content:space-between">
                <div>
                  <div class="muted" style="font-size:12px">Passengers (est.)</div>
                  <div id="pax"><b>‚Äî</b></div>
                </div>
                <div>
                  <div class="muted" style="font-size:12px">Weather</div>
                  <div id="wx"><b>‚Äî</b></div>
                </div>
              </div>
              <div class="spacer" style="height:12px"></div>
              <div class="muted" id="aiNote" style="font-size:13px">Select a flight to see AI verdict.</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Lists -->
        <div id="right" class="card">
          <h3>Active Alerts</h3>
          <div id="alerts" class="list"></div>
          <div class="spacer"></div>
          <h3>Active Flights (US)</h3>
          <input id="search" placeholder="Search airline / flight / origin / dest" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,0.04);color:var(--text);margin-bottom:10px"/>
          <div id="flightsList" class="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section id="analytics">
    <div class="container">
      <span class="pill">Analytics</span>
      <h2>Safety Insights (Past 5 Years)</h2>
      <div class="grid">
        <div class="card">
          <h3>Aircraft Incidents (2019‚Äì2024)</h3>
          <canvas id="incidentsChart" height="160"></canvas>
        </div>
        <div class="card">
          <h3>Incident Causes</h3>
          <canvas id="causesChart" height="160"></canvas>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <h3>US Incidents ‚Äî Sample (for demo)</h3>
        <table id="incidentsTable">
          <thead><tr><th>Date</th><th>Airline</th><th>Flight</th><th>Location</th><th>Cause</th><th>Wx</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ABOUT SKYGUARD -->
  <section id="about-skyguard">
    <div class="container about-grid">
      <div class="card">
        <span class="pill">About SkyGuard</span>
        <h2>Problem ‚Üí Data ‚Üí Solution</h2>
        <p class="lead">
          US skies are busy: thousands of simultaneous flights, evolving weather, and tight schedules.  
          Small risks compound into <b>near-misses</b> and delays that cost airlines money and stress passengers.
        </p>
        <div class="spacer"></div>
        <h3>‚ùó The Problem</h3>
        <ul class="check">
          <li>Crews juggle <b>dynamic weather</b>, <b>traffic</b>, and <b>altitude separation</b> in real-time.</li>
          <li>Existing tools are siloed: radar here, weather there ‚Äî no single live, intuitive view.</li>
          <li>Passengers get vague alerts; ops miss chances to <b>proactively de-risk</b> routes.</li>
        </ul>
        <div class="spacer"></div>
        <h3>üß™ Data (Demo)</h3>
        <ul class="check">
          <li>Simulated US flight telemetry (OpenSky-like structure)</li>
          <li>Deterministic weather severity (winds + visibility)</li>
          <li>Five-year incident sample for analytics</li>
          <li>Passenger loads from airline seat maps √ó load factor</li>
        </ul>
        <div class="spacer"></div>
        <h3>‚úÖ The Solution</h3>
        <ul class="check">
          <li>Live 3D globe, <b>clickable planes</b>, compass, route arcs</li>
          <li>Explainable AI risk score (distance, closure, altitude, weather)</li>
          <li>AI verdict: ‚ÄúSafe to board / Moderate / Elevated‚Äù</li>
          <li>Clear ops insights + historic causes</li>
        </ul>
      </div>

      <div class="card">
        <span class="pill">Airlines Tracked (demo)</span>
        <div class="marquee" style="margin-top:10px">
          <div class="track">
            <span class="badge">Alaska</span><span class="badge">United</span><span class="badge">American</span>
            <span class="badge">Delta</span><span class="badge">Southwest</span><span class="badge">JetBlue</span>
            <span class="badge">Frontier</span><span class="badge">Spirit</span><span class="badge">Hawaiian</span>
            <span class="badge">Allegiant</span>
            <span class="badge">Alaska</span><span class="badge">United</span><span class="badge">American</span>
            <span class="badge">Delta</span><span class="badge">Southwest</span><span class="badge">JetBlue</span>
            <span class="badge">Frontier</span><span class="badge">Spirit</span><span class="badge">Hawaiian</span>
            <span class="badge">Allegiant</span>
          </div>
        </div>

        <div class="spacer"></div>
        <h3>üìà Impact</h3>
        <p class="muted">Fewer surprises. Better comms. Higher confidence for crews and passengers.</p>
        <div class="spacer"></div>
        <h3>‚ùì FAQ</h3>
        <details>
          <summary>Is this live data?</summary>
          <div class="muted">Single-file demo uses simulated flights + deterministic weather. Real feeds can be wired later.</div>
        </details>
        <details>
          <summary>What‚Äôs the AI verdict based on?</summary>
          <div class="muted">Distance, closure, altitude separation, weather severity ‚Äî via an explainable sigmoid model.</div>
        </details>
      </div>
    </div>
  </section>

  <!-- TEAM -->
  <section id="team">
    <div class="container">
      <span class="pill">Team</span>
      <h2>Who built SkyGuard</h2>
      <p class="muted" style="max-width:860px">
        We‚Äôre a team of <b>freshmen at the University of Washington</b>.  
        Everyone is in <b>Computer Science</b> ‚Äî <b>except Shuab</b>, who‚Äôs in <b>Informatics</b>.
      </p>
      <div class="team">
        <div class="person"><div class="avatar">SN</div><div><b>Shuab</b></div><div class="role">Informatics @ UW (Freshman)</div><p class="muted">Product + data wiring. Led the user story, risk explainability, and demo polish.</p></div>
        <div class="person"><div class="avatar">NA</div><div><b>Nasrat</b></div><div class="role">Computer Science @ UW (Freshman)</div><p class="muted">3D interactions + UI systems. Clean layouts and smooth animations.</p></div>
        <div class="person"><div class="avatar">AH</div><div><b>Ahmed</b></div><div class="role">Computer Science @ UW (Freshman)</div><p class="muted">Risk engine + routing math. Fast client logic.</p></div>
        <div class="person"><div class="avatar">J</div><div><b>Jackson</b></div><div class="role">Computer Science @ UW (Freshman)</div><p class="muted">Data viz & charts. Analytics, incidents view, compass widget.</p></div>
      </div>
      <div class="spacer"></div>
      <div class="card" style="text-align:center">
        <h3 style="margin-bottom:6px">What we‚Äôre proud of</h3>
        <p class="muted" style="margin-top:0">Turning complex aviation data into a <b>clear, interactive experience</b> in hackathon time.</p>
        <div class="row" style="justify-content:center;margin-top:12px">
          <a class="btn primary" href="#dashboard">See Live Map</a>
          <a class="btn" href="#home">Back to top</a>
        </div>
      </div>
    </div>
  </section>

  <!-- AI COPILOT -->
  <section id="copilot">
    <div class="container">
      <span class="pill">AI Copilot</span>
      <h2>Ask about a flight ‚Äî see route, weather & a safety verdict</h2>
      <div class="card chat">
        <div class="inputRow">
          <input id="chatInput" placeholder="Try: AS 348 KSEA KSFO" />
          <button class="btn primary" id="chatGo">Go</button>
        </div>
        <div class="chipRow">
          <span class="badgeMini">ETA: <span id="eta">‚Äî</span></span>
          <span class="badgeMini">Distance: <span id="dist">‚Äî</span> NM</span>
          <span class="badgeMini">Passengers est.: <span id="chatPax">‚Äî</span></span>
        </div>
        <div class="spacer"></div>
        <div id="verdict" class="muted">Enter airline + flight + from + to (e.g., AS 348 KSEA KSFO)</div>
      </div>
    </div>
  </section>

  <footer>
    <div class="container">¬© SkyGuard ‚Äî Built at DubHacks 2025 ‚Ä¢ University of Washington</div>
  </footer>

<!-- ===================== ALL JS (MODULE) ===================== -->
<script type="module">
/* Import Three.js + OrbitControls via ESM (fixes all THREE errors) */
import * as THREE from "https://esm.sh/three@0.161.0";
import { OrbitControls } from "https://esm.sh/three@0.161.0/examples/jsm/controls/OrbitControls.js";
// try to replace sim with real data from backend (keeps the same structure)


/* ---------- Stars background ---------- */
const stars = document.getElementById('stars');
if (stars) {
  const ctx = stars.getContext('2d');
  function resizeStars(){ stars.width = innerWidth; stars.height = innerHeight; }
  addEventListener('resize', resizeStars); resizeStars();
  let starPts = Array.from({length:160}, ()=>({x:Math.random()*stars.width, y:Math.random()*stars.height, r:Math.random()*1.2+0.3, s:Math.random()*0.4+0.1}));
  (function anim(){ ctx.clearRect(0,0,stars.width,stars.height);
    ctx.globalAlpha=1;
    ctx.fillStyle='#A8C5FF';
    starPts.forEach(p=>{ ctx.globalAlpha=0.5+Math.sin((performance.now()*p.s + p.x)/700)*0.5; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();});
    requestAnimationFrame(anim);
  })();
}

/* ---------- Typewriter ---------- */
const target = document.getElementById('typeTarget');
if (target){
  const full = 'SkyGuard'; let i=0; target.textContent='';
  function type(){ if(i<=full.length){ target.textContent=full.slice(0,i); i++; setTimeout(type, i<full.length?90:250);} }
  setTimeout(type, 400);
}

/* ---------- Smooth scroll nav ---------- */
document.querySelectorAll('a[href^="#"]').forEach(a=>{
  a.addEventListener('click', e=>{
    const id = a.getAttribute('href'); if(id.length>1){ e.preventDefault(); document.querySelector(id).scrollIntoView({behavior:'smooth', block:'start'}); }
  });
});

/* =========================================================
   LIVE GLOBE + FLIGHTS (Three.js)
========================================================= */
const airlines = ["AA","DL","UA","AS","WN","B6","NK","F9","HA","G4"];
const airlineSeats = {AA:180,DL:176,UA:178,AS:172,WN:143,B6:162,NK:182,F9:180,HA:189,G4:186};
const chips = document.getElementById('airlineChips');
let activeAirline = null;
if (chips){
  chips.innerHTML = airlines.map(a=>`<span class="chip" data-a="${a}">${a}</span>`).join('');
  chips.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      if(activeAirline === ch.dataset.a){ activeAirline=null; } else { activeAirline = ch.dataset.a; ch.classList.add('active'); }
      refreshFlightList(); repaintPlanes();
    });
  });
}

const holder = document.getElementById('globeHolder');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, holder.clientWidth/holder.clientHeight, 0.1, 1000);
camera.position.set(0,0,3.2);
const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(holder.clientWidth, holder.clientHeight);
renderer.setPixelRatio(devicePixelRatio || 1);
holder.appendChild(renderer.domElement);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping=true; controls.dampingFactor=0.08; controls.minDistance=1.8; controls.maxDistance=6; controls.enablePan=false;

/* Earth sphere */
const earthGeo = new THREE.SphereGeometry(1, 64, 64);
const earthMat = new THREE.MeshPhongMaterial({ color: 0x0e203a, emissive:0x0a1222, shininess:6, specular:0x111111 });
const earth = new THREE.Mesh(earthGeo, earthMat);
scene.add(earth);

/* Grid lines (BufferGeometry) */
const gridMat = new THREE.LineBasicMaterial({ color: 0x1f3a66, transparent:true, opacity:0.35 });
function addLineFromPoints(points){
  const pos = new Float32Array(points.length * 3);
  points.forEach((p,i)=>{ pos[i*3]=p.x; pos[i*3+1]=p.y; pos[i*3+2]=p.z; });
  const geom = new THREE.BufferGeometry();
  geom.setAttribute('position', new THREE.BufferAttribute(pos, 3));
  scene.add(new THREE.Line(geom, gridMat));
}
function latLonToVec3(lat, lon, radius=1){
  const phi = (90-lat)*Math.PI/180; const theta=(lon+180)*Math.PI/180;
  return { x: -radius*Math.sin(phi)*Math.cos(theta), y: radius*Math.cos(phi), z: radius*Math.sin(phi)*Math.sin(theta)};
}
for(let lat=-60; lat<=60; lat+=30){
  const pts=[];
  for(let lon=-180; lon<=180; lon+=2){
    const v = latLonToVec3(lat, lon, 1.001);
    pts.push(new THREE.Vector3(v.x, v.y, v.z));
  }
  addLineFromPoints(pts);
}
for(let lon=-180; lon<=180; lon+=30){
  const pts=[];
  for(let lat=-80; lat<=80; lat+=2){
    const v = latLonToVec3(lat, lon, 1.001);
    pts.push(new THREE.Vector3(v.x, v.y, v.z));
  }
  addLineFromPoints(pts);
}

/* Stars */
const starGeom = new THREE.BufferGeometry(); const starCnt=1000;
const starPos = new Float32Array(starCnt*3);
for(let i=0;i<starCnt;i++){ const r=40; const t=randSph(); starPos[i*3]=t.x*r; starPos[i*3+1]=t.y*r; starPos[i*3+2]=t.z*r; }
starGeom.setAttribute('position', new THREE.BufferAttribute(starPos,3));
const stars3 = new THREE.Points(starGeom, new THREE.PointsMaterial({color:0x88aaff,size:0.08,transparent:true,opacity:0.4}));
scene.add(stars3);

/* Lights */
scene.add(new THREE.AmbientLight(0x6680aa, 0.9));
const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(5,3,2); scene.add(dir);

/* Helpers */
function rand(min,max){ return Math.random()*(max-min)+min; }
function randSph(){ const u=Math.random(), v=Math.random(); const theta = 2*Math.PI*u, phi = Math.acos(2*v-1); return { x: Math.sin(phi)*Math.cos(theta), y: Math.cos(phi), z: Math.sin(phi)*Math.sin(theta) }; }
function inBoxes(lat,lon){ const boxes=[[-125,24.5,-66.9,49.5],[-170,51,-129,71],[-161,18.8,-154,22.4]]; return boxes.some(([lmin,bmin,lmax,bmax])=> lon>=lmin&&lon<=lmax&&lat>=bmin&&lat<=bmax ); }
function project(lat,lon,vel_kt,hdg,dt_sec){ const dist_nm = vel_kt*(dt_sec/3600); const theta = hdg*Math.PI/180; const dlat_deg = (Math.cos(theta)*dist_nm)/60; const dlon_deg = (Math.sin(theta)*dist_nm)/(60*Math.cos(lat*Math.PI/180) || 1e-6); return { lat: lat+dlat_deg, lon: lon+dlon_deg }; }
function closureRate(a,b){ const thA=a.hdg*Math.PI/180, thB=b.hdg*Math.PI/180; const ax=Math.sin(thA), ay=Math.cos(thA), bx=Math.sin(thB), by=Math.cos(thB); const closing = Math.max(0, (ax*-bx + ay*-by)); return closing * ((a.vel_kt+b.vel_kt)/2); }
function havNM(a,b){ const R=3440.065, toR=d=>d*Math.PI/180; const dlat=toR(b.lat-a.lat), dlon=toR(b.lon-a.lon); const la=toR(a.lat), lb=toR(b.lat); const h=Math.sin(dlat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dlon/2)**2; return 2*R*Math.asin(Math.sqrt(Math.min(1,h))); }
function wxIndex(lat,lon){ const winds = 5 + 30*Math.abs(Math.sin(lat*0.15))*Math.abs(Math.cos(lon*0.1)); const vis = 4 + 6*Math.abs(Math.cos(lat*0.2)); const sev = Math.min(1, 0.5*(winds/40) + 0.5*((10-vis)/10)); return { winds: winds.toFixed(0), visibility: vis.toFixed(1), severity: +sev.toFixed(2) }; }
function paxEstimate(airline){ const seats=airlineSeats[airline] || 170; const lf = 0.72 + Math.random()*0.22; return { seats, loadFactor:+lf.toFixed(2), est: Math.round(seats*lf) }; }

/* Flights */
function generateUSFlights(n){
  const arr=[];
  for(let i=0;i<n;i++){
    let lat,lon; do{ lat=rand(25,49), lon=rand(-124,-67); } while(!inBoxes(lat,lon));
    const a = airlines[Math.floor(Math.random()*airlines.length)];
    arr.push({ id:`F${i.toString().padStart(3,'0')}`, airline:a, lat, lon, alt_ft:rand(26000,38000), vel_kt:rand(380,480), hdg:rand(0,360), origin:"KSEA", dest:"KSFO" });
  }
  const centerLat=39.5, centerLon=-98.35;
  arr[arr.length-1]={ id:"DANGER1", airline:"AS", lat:centerLat+0.3, lon:centerLon, alt_ft:32000, vel_kt:430, hdg:180, origin:"KDEN", dest:"KDFW" };
  arr[arr.length-2]={ id:"DANGER2", airline:"UA", lat:centerLat-0.3, lon:centerLon, alt_ft:32600, vel_kt:420, hdg:0, origin:"KDFW", dest:"KDEN" };
  return arr;
}
const flights = generateUSFlights(120);
let running = true, showWeather=false;
// swap in real flights from the backend if available
(async () => {
  try {
    const r = await fetch('/api/flights');
    const j = await r.json();
    if (Array.isArray(j.flights) && j.flights.length) {
      // keep array length stable so other code works the same
      const take = j.flights.slice(0, flights.length);
      for (let i = 0; i < take.length; i++) {
        flights[i] = { ...flights[i], ...take[i] };
      }
      // refresh UI now that flights content changed
      repaintPlanes?.();
      renderAlerts?.();
      refreshFlightList?.();
      console.log('üõ∞Ô∏è using', j.source, `(${take.length} flights)`);
    } else {
      console.log('using simulated (backend returned empty)');
    }
  } catch (e) {
    console.log('using simulated (fetch failed):', e?.message || e);
  }
})();

/* Plane meshes */
const planeGeo = new THREE.ConeGeometry(0.012, 0.05, 5);
const planeMat = new THREE.MeshBasicMaterial({ color: 0x8ab4ff });
const planeMeshes = new Map();
flights.forEach(f=>{
  const mesh = new THREE.Mesh(planeGeo, planeMat.clone());
  mesh.material.color = new THREE.Color(airlines.indexOf(f.airline)%2 ? 0x8ab4ff : 0x7cc1ff);
  const v = latLonToVec3(f.lat,f.lon,1.005);
  mesh.position.set(v.x,v.y,v.z);
  mesh.lookAt(new THREE.Vector3(0,0,0));
  mesh.rotateX(Math.PI/2);
  planeMeshes.set(f.id, mesh);
  scene.add(mesh);
});

/* Raycaster for clicks */
const ray = new THREE.Raycaster();
const mouse = new THREE.Vector2();
renderer.domElement.addEventListener('click', (ev)=>{
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((ev.clientX-rect.left)/rect.width)*2 - 1;
  mouse.y = -((ev.clientY-rect.top)/rect.height)*2 + 1;
  ray.setFromCamera(mouse, camera);
  const hits = ray.intersectObjects([...planeMeshes.values()]);
  if(hits.length){ const mesh = hits[0].object; const id = [...planeMeshes.entries()].find(([k,v])=>v===mesh)[0]; onSelectFlight(id); }
});

/* Resize */
addEventListener('resize', ()=>{
  renderer.setSize(holder.clientWidth, holder.clientHeight);
  camera.aspect = holder.clientWidth/holder.clientHeight; camera.updateProjectionMatrix();
});

/* Controls UI */
document.getElementById('playPause').onclick=()=>{ running=!running; document.querySelector('#playPause span').textContent = running? 'Pause':'Play'; };
document.getElementById('wxToggle').onclick=()=>{ showWeather=!showWeather; document.querySelector('#wxToggle span').textContent = showWeather? 'Wx On':'Weather'; repaintPlanes(); };

/* Drawer & details */
const drawer = document.getElementById('drawer');
function onSelectFlight(id){
  const f = flights.find(x=>x.id===id); if(!f) return;
  drawer.classList.add('show');
  document.getElementById('drawerTitle').textContent = `${f.airline} ‚Ä¢ ${f.id}`;
  document.getElementById('drawerAirline').textContent = f.airline;
  document.getElementById('spAlt').textContent = `${f.vel_kt.toFixed(0)} kt / ${(f.alt_ft/1000).toFixed(1)}k ft`;
  document.getElementById('needle').style.transform = `rotate(${f.hdg}deg)`;
  const pax = paxEstimate(f.airline); document.getElementById('pax').innerHTML = `<b>${pax.est}</b> / ${pax.seats} (${Math.round(pax.loadFactor*100)}%)`;
  const wx = wxIndex(f.lat,f.lon); document.getElementById('wx').innerHTML = `<b>${wx.winds} kt</b>, vis ${wx.visibility} mi, sev ${wx.severity}`;
  const verdict = wx.severity<=0.3 ? 'Safe to board ‚Äî conditions favorable.' :
                  (wx.severity<=0.6 ? 'Moderate weather; mild turbulence possible ‚Äî overall low risk.' :
                   'Elevated weather risk ‚Äî expect precautions or minor reroute.');
  document.getElementById('aiNote').textContent = verdict;
}

/* Alerts + list UI */
const alertsDiv = document.getElementById('alerts');
const flightsListDiv = document.getElementById('flightsList');
const searchEl = document.getElementById('search');
if (searchEl) searchEl.addEventListener('input', refreshFlightList);

function refreshFlightList(){
  const q = (searchEl?.value || '').toLowerCase();
  const arr = flights.filter(f=>{
    if(activeAirline && f.airline!==activeAirline) return false;
    const test = (f.id + f.airline + (f.origin||'') + (f.dest||'')).toLowerCase();
    return test.includes(q);
  }).slice(0,60);
  flightsListDiv.innerHTML = arr.map(f=>`
    <div class="rowItem">
      <div><b>${f.airline}</b> ${f.id} <span class="muted">‚Ä¢ ${f.origin}‚Üí${f.dest}</span></div>
      <button class="btn" data-jump="${f.id}">View</button>
    </div>
  `).join('');
  flightsListDiv.querySelectorAll('button[data-jump]').forEach(b=>{
    b.onclick=()=>{ focusFlight(b.dataset.jump); onSelectFlight(b.dataset.jump); };
  });
}
function focusFlight(id){
  const f = flights.find(x=>x.id===id); if(!f) return;
  const v = latLonToVec3(f.lat,f.lon,2.6);
  camera.position.set(v.x,v.y,v.z); camera.lookAt(0,0,0);
}

/* Risk model */
function riskPairs(){
  const sample = flights.slice(0,80);
  const out=[];
  for(let i=0;i<sample.length;i++){
    for(let j=i+1;j<sample.length;j++){
      const a=sample[i], b=sample[j];
      if(Math.abs(a.alt_ft-b.alt_ft)>2500) continue;
      const d = havNM(a,b); if(d>25) continue;
      const clos = closureRate(a,b);
      const wx = (wxIndex((a.lat+b.lat)/2,(a.lon+b.lon)/2).severity);
      const invd = 1/Math.max(0.1,d);
      const altTerm = Math.max(0,(1000-Math.abs(a.alt_ft-b.alt_ft)))/1000;
      const score = 1/(1+Math.exp(-(1.2*invd + 0.8*(clos/500) + 1.0*altTerm + 0.6*wx)));
      if(score>0.35) out.push({a:a.id,b:b.id,score, d});
    }
  }
  return out.sort((x,y)=>y.score-x.score).slice(0,5);
}
function renderAlerts(){
  const arr = riskPairs();
  alertsDiv.innerHTML = arr.map(r=>{
    const c = r.score>0.75?'var(--red)': r.score>0.4?'var(--orange)':'var(--green)';
    return `<div class="rowItem">
      <div><b>${r.a}</b> ‚Üî <b>${r.b}</b> <span class="muted">(${r.d.toFixed(1)} NM)</span></div>
      <div class="riskbar"><span style="width:${Math.round(r.score*100)}%; background:${c}"></span></div>
    </div>`;
  }).join('');
}

/* Weather overlay */
const wxDots = [];
function drawWeatherDots(){
  wxDots.forEach(m=>scene.remove(m)); wxDots.length=0;
  if(!showWeather) return;
  const pts=[];
  for(let lat=25; lat<=49; lat+=6){ for(let lon=-124; lon<=-67; lon+=6) pts.push({lat,lon}); }
  pts.forEach(p=>{
    const sev = wxIndex(p.lat,p.lon).severity;
    const color = sev>0.6? 0xff3b30 : sev>0.3? 0xff9f0a : 0x34c759;
    const dot = new THREE.Mesh(new THREE.SphereGeometry(0.01,8,8), new THREE.MeshBasicMaterial({color, transparent:true, opacity:0.7}));
    const v = latLonToVec3(p.lat,p.lon,1.02); dot.position.set(v.x,v.y,v.z);
    wxDots.push(dot); scene.add(dot);
  });
}

/* Animate loop */
let lastMove=0;
function repaintPlanes(){
  flights.forEach(f=>{
    const mesh = planeMeshes.get(f.id);
    if(activeAirline && f.airline!==activeAirline){ mesh.visible=false; return; } else { mesh.visible=true; }
    const v = latLonToVec3(f.lat,f.lon,1.005);
    mesh.position.set(v.x,v.y,v.z);
    mesh.lookAt(0,0,0);
    mesh.rotateX(Math.PI/2);
    mesh.rotateZ(THREE.MathUtils.degToRad(f.hdg));
  });
  drawWeatherDots();
}
function tick(ts){
  requestAnimationFrame(tick);
  controls.update();
  if(running && ts-lastMove>3000){
    flights.forEach(f=>{
      const nxt = project(f.lat,f.lon,f.vel_kt,f.hdg,3);
      f.lat=nxt.lat; f.lon=nxt.lon;
      if(!inBoxes(f.lat,f.lon)){ f.hdg = (f.hdg+120)%360; }
    });
    lastMove=ts;
    repaintPlanes();
    renderAlerts();
  }
  renderer.render(scene,camera);
}
refreshFlightList(); renderAlerts(); repaintPlanes(); tick();

/* Keyboard */
addEventListener('keydown', (e)=>{
  if(e.code==='Space'){ running=!running; document.querySelector('#playPause span').textContent = running? 'Pause':'Play'; }
  if(e.key==='w' || e.key==='W'){ showWeather=!showWeather; document.querySelector('#wxToggle span').textContent = showWeather? 'Wx On':'Weather'; repaintPlanes(); }
});

/* =========================================================
   ANALYTICS ‚Äî charts + table
========================================================= */
const incCtx = document.getElementById('incidentsChart');
const causesCtx = document.getElementById('causesChart');
if (incCtx && causesCtx){
  const incidentsData = [120,132,140,136,150,158,165,172,168,160,155,150,148,152,158,161,167,170,162,158];
  new Chart(incCtx, {
    type:'line',
    data:{ labels:['2019 Q1','Q2','Q3','Q4','2020 Q1','Q2','Q3','Q4','2021 Q1','Q2','Q3','Q4','2022 Q1','Q2','Q3','Q4','2023 Q1','Q2','Q3','Q4'],
           datasets:[{label:'Incidents', data: incidentsData, borderColor:'#60A5FA', backgroundColor:'rgba(96,165,250,.15)', tension:.25, fill:true}]},
    options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#9AA4B2'}},y:{ticks:{color:'#9AA4B2'}}}}
  });
  new Chart(causesCtx, {
    type:'doughnut',
    data:{ labels:['Weather','Human','Mechanical','Other'],
           datasets:[{data:[32,28,26,14], backgroundColor:['#60A5FA','#34C759','#FF9F0A','#A78BFA']}]},
    options:{ plugins:{legend:{labels:{color:'#E6EDF6'}}}}
  });
}
const tableRows = [
  {date:'2021-07-11', airline:'UA', flight:'UA328', location:'Denver, CO', cause:'Engine failure; safe landing', wx:true},
  {date:'2022-12-26', airline:'AS', flight:'AS35', location:'SEA', cause:'Runway excursion (snow/ice)', wx:true},
  {date:'2023-08-03', airline:'DL', flight:'DL1437', location:'ATL', cause:'Severe turbulence on descent', wx:true},
  {date:'2020-10-19', airline:'AA', flight:'AA104', location:'DFW', cause:'Hydraulic issue', wx:false},
  {date:'2024-03-02', airline:'WN', flight:'WN2862', location:'PHX', cause:'Bird strike; return to field', wx:false},
  {date:'2022-06-14', airline:'B6', flight:'B61720', location:'BOS', cause:'Weather diversion', wx:true},
  {date:'2021-09-21', airline:'F9', flight:'F91608', location:'MCO', cause:'Instrument fault', wx:false},
  {date:'2024-01-28', airline:'NK', flight:'NK802', location:'LAS', cause:'Cabin pressurization warning', wx:false},
  {date:'2019-11-07', airline:'HA', flight:'HA22', location:'HNL', cause:'Tropical storm deviation', wx:true},
  {date:'2020-05-18', airline:'G4', flight:'G4113', location:'SFB', cause:'Brake temp sensor', wx:false},
];
const tbody = document.querySelector('#incidentsTable tbody');
if (tbody){
  tbody.innerHTML = tableRows.map(r=>`
    <tr><td>${r.date}</td><td>${r.airline}</td><td>${r.flight}</td><td>${r.location}</td><td>${r.cause}</td><td>${r.wx? 'üåßÔ∏è':'‚Äî'}</td></tr>
  `).join('');
}

/* =========================================================
   AI COPILOT ‚Äî parse query, draw route, verdict
========================================================= */
function greatCircle(aLat,aLon,bLat,bLon,n=13){
  const toR=d=>d*Math.PI/180, toD=r=>r*180/Math.PI;
  const œÜ1=toR(aLat), Œª1=toR(aLon), œÜ2=toR(bLat), Œª2=toR(bLon);
  const Œî=2*Math.asin(Math.sqrt(Math.sin((œÜ2-œÜ1)/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin((Œª2-Œª1)/2)**2));
  if(Œî===0) return Array.from({length:n},()=>({lat:aLat,lon:aLon}));
  const out=[];
  for(let i=0;i<n;i++){
    const f=i/(n-1), A=Math.sin((1-f)*Œî)/Math.sin(Œî), B=Math.sin(f*Œî)/Math.sin(Œî);
    const x=A*Math.cos(œÜ1)*Math.cos(Œª1)+B*Math.cos(œÜ2)*Math.cos(Œª2);
    const y=A*Math.cos(œÜ1)*Math.sin(Œª1)+B*Math.cos(œÜ2)*Math.sin(Œª2);
    const z=A*Math.sin(œÜ1)+B*Math.sin(œÜ2);
    const œÜ=Math.atan2(z,Math.hypot(x,y)), Œª=Math.atan2(y,x);
    out.push({lat:toD(œÜ),lon:toD(Œª)});
  }
  return out;
}
function distNM(lat1,lon1,lat2,lon2){
  const R=3440.065, toR=d=>d*Math.PI/180;
  const dlat=toR(lat2-lat1), dlon=toR(lon2-lon1), la=toR(lat1), lb=toR(lat2);
  const h=Math.sin(dlat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dlon/2)**2;
  return 2*R*Math.asin(Math.sqrt(Math.min(1,h)));
}
let routeLine;
function clearRoute(){ if(routeLine){ scene.remove(routeLine); routeLine.geometry.dispose(); } routeLine=null; }
function drawRoute(points){
  clearRoute();
  const geom = new THREE.BufferGeometry();
  const pos = new Float32Array(points.length*3);
  points.forEach((p,i)=>{ const v=latLonToVec3(p.lat,p.lon,1.01); pos[i*3]=v.x; pos[i*3+1]=v.y; pos[i*3+2]=v.z; });
  geom.setAttribute('position', new THREE.BufferAttribute(pos,3));
  routeLine = new THREE.Line(geom, new THREE.LineBasicMaterial({color:0x60A5FA, transparent:true, opacity:0.9}));
  scene.add(routeLine);
}
function parseQuery(s){
  const parts = s.trim().split(/\s+/);
  if (parts.length < 4) return null;
  const airline = parts[0].toUpperCase();
  const flight  = parts[1].toUpperCase();
  const from    = parts[2].toUpperCase();
  const to      = parts[3].toUpperCase();
  const airports = {
    KSEA:{lat:47.448,lon:-122.309}, KSFO:{lat:37.621,lon:-122.379}, KJFK:{lat:40.641,lon:-73.778},
    KLAX:{lat:33.942,lon:-118.408}, KDEN:{lat:39.856,lon:-104.673}, KDFW:{lat:32.899,lon:-97.040}
  };
  return { airline, flight, from, to, airports };
}

document.getElementById('chatGo').onclick=async ()=>{
  const q=document.getElementById('chatInput').value;
  const parsed=parseQuery(q);
  const verdictEl=document.getElementById('verdict');
  if(!parsed || !parsed.airports[parsed.from] || !parsed.airports[parsed.to]){
    verdictEl.textContent='Format: AS 348 KSEA KSFO (use KSEA/KLAX/KJFK/KSFO/KDEN/KDFW)';
    return;
  }
  const A=parsed.airports[parsed.from], B=parsed.airports[parsed.to];
  const pts=greatCircle(A.lat,A.lon,B.lat,B.lon,13);
  drawRoute(pts);

  let worst=0, dist=0;
  for(let i=0;i<pts.length-1;i++){
    const sev=wxIndex(pts[i].lat,pts[i].lon).severity; worst=Math.max(worst,sev);
    dist+=distNM(pts[i].lat,pts[i].lon,pts[i+1].lat,pts[i+1].lon);
  }
  const etaMin = Math.round((dist/430)*60);
  document.getElementById('dist').textContent = Math.round(dist);
  document.getElementById('eta').textContent = `${etaMin} min`;
  const pax = paxEstimate(parsed.airline); document.getElementById('chatPax').textContent = `${pax.est} / ${pax.seats}`;
  const msg = worst<=0.3 ? 'Safe to board ‚Äî conditions favorable.' :
              (worst<=0.6 ? 'Moderate weather; mild turbulence possible ‚Äî overall low risk.' :
               'Elevated risk due to weather/traffic ‚Äî expect precautions.');
  verdictEl.innerHTML = `‚úàÔ∏è <b>${parsed.airline}${parsed.flight}</b> ${parsed.from}‚Üí${parsed.to}<br/>üß≠ ETA ${etaMin} min ‚Ä¢ üìè ${Math.round(dist)} NM<br/>üß† ${msg}`;

  // optional: log to backend (works with your server.js)
  try {
    await fetch('/api/logs', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'copilot_query', payload:{ q, etaMin, distNM:Math.round(dist), verdict:msg } })
    });
  } catch(e){}
  
  // Center camera mid-route
  const mid=pts[Math.floor(pts.length/2)]; const v=latLonToVec3(mid.lat,mid.lon,2.6); camera.position.set(v.x,v.y,v.z); camera.lookAt(0,0,0);
};
</script>
</body>
</html>
